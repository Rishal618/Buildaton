<!DOCTYPE html>
<html>
  <head>
    <title>Advisor Screen</title>
    <link rel="stylesheet" type="text/css" href="styles/principal-screen.css">
    <link rel="stylesheet" type="text/css" href="styles/navbar.css">
    <link rel="stylesheet" type="text/css" href="styles/submitted-letters.css">
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge"> 
    <meta name="viewport" content="width=device-width, initial-scale=1.0">


    <link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap" rel="stylesheet">
  </head>
  <body>
    <nav>
        <ul class="side-bar">
            <li onclick=hideSidebar()><a href="#"><svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#1f1f1f"><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></a></li>
            
            <li><a href="#">About</a></li>
            <li><a href="#">Contact</a></li>
            <li><a href="login.html">Log out</a></li>
        </ul>
        <ul class="header">
            <li><a href="#">
              <div class="logo-text-div">
                  Requesta
                  <div class="logo-image-div"><img src="requesta-logo-navbar.png" style="width: 120px;"></div>
                </div>
              </a>
            </li>
            
            <li class="hideOnmobile"><a href="#">About</a></li>
            <li class="hideOnmobile"><a href="#">Contact</a></li>
            <li onclick=showSidebar()><a href="#"><svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#1f1f1f"><path d="M120-240v-80h720v80H120Zm0-200v-80h720v80H120Zm0-200v-80h720v80H120Z"/></svg></a></li>
        </ul>
    </nav>


    <div class="tab-main">
      <div class="status-tabs"> 
        <div class="tab tab-pending" onclick="showTab('pending')">
          <p>Pending</p>
        </div>
        <div class="tab" onclick="showTab('approved')">
          <p>Approved</p>
        </div>
        <div class="tab" onclick="showTab('rejected')">
          <p>Rejected</p>
        </div>
      </div>
    


    <div class="messages-area">
      <div id="pending" class="messages">
        
      </div>
      <div id="approved" class="messages">
        
      </div>
      <div id="rejected" class="messages">
        
      </div>
    </div>


    <div id="applications"></div>

    <script src="js/work-flow.js"></script>

    <script>
      function showSidebar() {
            const sideBar = document.querySelector('.side-bar');
            sideBar.style.display = 'flex';
        }
        function hideSidebar() {
            const sideBar = document.querySelector('.side-bar');
            sideBar.style.display = 'none';
        }

        
async function loadAdvisorPending() { 
  const token = localStorage.getItem("token"); 
  const resp = await fetch("http://localhost:4000/api/applications/advisor/pending", 
  { headers: { "Authorization": `Bearer ${token}` } }); 
  const apps = await resp.json(); renderMessages("pending", apps, "Pending"); 
} 
async function loadAdvisorApproved() { 
  const token = localStorage.getItem("token"); 
  const resp = await fetch("http://localhost:4000/api/applications/advisor/approved", 
  { headers: { "Authorization": `Bearer ${token}` } }); 
  const apps = await resp.json(); 
  renderMessages("approved", apps, "Approved"); 
} 
async function loadAdvisorRejected() { 
  const token = localStorage.getItem("token"); const resp = await fetch("http://localhost:4000/api/applications/advisor/rejected", 
  { headers: { "Authorization": `Bearer ${token}` } }); 
  const apps = await resp.json(); renderMessages("rejected", apps, "Rejected"); 
} 
function renderMessages(tabId, apps, statusLabel) 
{ 
  document.getElementById(tabId).innerHTML = apps.length === 0 ? `<p class="approved-letter-div">No ${statusLabel.toLowerCase()} letters.</p>` :
   apps.map(a => ` <div class="approved-letter-div"> 
    <p><strong>From:</strong><br><br> ${a.name}</p> 
    <p>${a.department} &nbsp; ${a.year}</p> 
    <p>${a.studentEmail}</p> 
    <p>${a.phoneNumber}</p><br> 
    <hr><br> 
    <p><strong>Subject:</strong> ${a.subject}</p> 
    <p class="approved-letter-body">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;${a.content}</p> 
    <div class="status-div-${statusLabel.toLowerCase()}">${statusLabel}</div> 
    ${statusLabel === "Pending" ? ` <div class="approve-reject-button-div"> 
      <button onclick="updateStatus('${a._id}', 'approve')" class="approve-button">Send to HOD</button> 
      <button onclick="updateStatus('${a._id}', 'reject')" class="reject-button">Reject</button> </div>` : ""} 
    </div>`
  ).join("");
   };

function showTab(tabId) {
  document.querySelectorAll(".messages").forEach(div => (div.style.display = "none"));
  document.getElementById(tabId).style.display = "block";
}

// Run on page load
loadAdvisorPending(); 
loadAdvisorApproved(); 
loadAdvisorRejected(); 
showTab("pending");

async function updateStatus(id, action) 
{ const token = localStorage.getItem("token"); 
try { const resp = await fetch(`http://localhost:4000/api/applications/${id}/status`, 
  { method: "PATCH", 
 headers: { "Content-Type": "application/json", 
 "Authorization": `Bearer ${token}` }, 
 body: JSON.stringify({ action }) }); 
 const data = await resp.json(); if (!resp.ok) { alert(data.error || "Failed to update status"); 
 return; } alert(`Application ${action}d successfully`); 
loadAdvisorPending(); 
loadAdvisorApproved(); 
loadAdvisorRejected(); } 
catch (err) { console.error("Error updating status:", err); alert("Failed to update status"); } }





  
      
    </script>
  </body>
</html>