<!DOCTYPE html>
<html>
  <head>

    
    <title>
      Submitted Letters
    </title>
    <link rel="stylesheet" type="text/css" href="styles/navbar.css">

    <link rel="stylesheet" type="text/css" href="styles/submitted-letters.css">
    


    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Navigation Bar</title>
    <link rel="stylesheet" href="styles/navbar.css">



    <link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap" rel="stylesheet">
   
  </head>
  <body>

    <nav>
        <ul class="side-bar">
            <li onclick=hideSidebar()><a href="#"><svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#1f1f1f"><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></a></li>
            <li><a href="home-page-main.html">Home</a></li>
            <li><a href="#">About</a></li>
            <li><a href="#">Contact</a></li>
            <li><a href="login.html">Log out</a></li>
        </ul>
        <ul>
            <li><a href="home-page-main.html">
              
                
                <div class="logo-text-div">
                  Requesta
                  <div class="logo-image-div"><img src="requesta-logo-navbar.png" style="width: 120px;"></div>

                </div>
              
              
              

            </a></li>
            <li class="hideOnmobile"><a href="home-page-main.html">Home</a></li>
            <li class="hideOnmobile"><a href="#">About</a></li>
            <li class="hideOnmobile"><a href="#">Contact</a></li>
            <li onclick=showSidebar()><a href="#"><svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#1f1f1f"><path d="M120-240v-80h720v80H120Zm0-200v-80h720v80H120Zm0-200v-80h720v80H120Z"/></svg></a></li>
        </ul>
    </nav>


    <div class="status-tabs ">
      <div class="tab tab-pending" onclick="showTab('pending')">
        <p>Pending</p>
      </div>
      <div class="tab" onclick="showTab('approved')">
        <p>Approved</p>
      </div>
      <div class="tab" onclick="showTab('rejected')">
        <p>Rejected</p>
      </div>
    </div>

    <div class="messages-area">
      <div id="pending" class="messages">
        
      </div>
      <div id="approved" class="messages">
        
      </div>
      <div id="rejected" class="messages">
        
      </div>
    </div>



    <div id="pdfContent" style="display:none"></div>
    
    
    <script src="/js/work-flow.js"></script>
     <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js">   
     </script>



    <script>
      function loadApproved(){
        let apps = JSON.parse(localStorage.getItem("applications")) || [];

        let approved = apps.filter(app => app.stage === "completed" && app.status === "Approved");
        
        let container = document.getElementById("approved");

        if (approved.length === 0) {
        container.innerHTML = `<p class="approved-letter-div">No approved letters .</p>`;
        return;
        }
        
        

        container.innerHTML = approved.map((a, index) => `
            <div class="approved-letter-div">
            <p class="approved-letter-from"><strong>From:</strong></p><br>
            <p class="approved-letter-from-user">${a.name}</p><br>
            <p class="approved-letter-from-user">${a.department} &nbsp; ${a.year}</p><br>
            <p class="approved-letter-from-user">${a.email}</p><br>
            <p class="approved-letter-from-user">${a.phoneNumber}</p><br>
            <hr>
                        
            
            <p class="approved-letter-subject"><strong>Subject:</strong> ${a.subject}</p>
            
            
            <p class="approved-letter-body">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;${a.body}</p>
            <div class="status-div-approved">Approved</div>
            <div class="download-button-div">
            <button onclick="downloadPDF(${index})" class="approved-download-button">Download Approved Letter</button>
            </div>
          </div>
         
        `
         ).join("");
      };
      loadApproved();
      loadRejected();
      loadPending();
      
      showTab('approved');
      
      function loadPending(){
        let apps = JSON.parse(localStorage.getItem("applications")) || [];

        let pending = apps.filter(app => app.stage === "Advisor" || app.stage === "HOD" || app.stage === "Principal" );
        
        let container = document.getElementById("pending");

        if (pending.length === 0) {
        container.innerHTML = `<p class="approved-letter-div">No pending letters .</p>`;
        return;
        }

         
        
        

        container.innerHTML = pending.map((a, index) => `
            <div class="approved-letter-div">
            <p class="approved-letter-from"><strong>From:</strong></p><br>
            <p class="approved-letter-from-user">${a.name}</p><br>
            <p class="approved-letter-from-user">${a.department} &nbsp; ${a.year}</p><br>
            <p class="approved-letter-from-user">${a.email}</p><br>
            <p class="approved-letter-from-user">${a.phoneNumber}</p><br>
            <hr>
             <p class="approved-letter-subject"><strong>Subject:</strong> ${a.subject}</p>
            
            
            <p class="approved-letter-body">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;${a.body}</p>
            <div class="status-div-pending">Pending</div>
            <div class="stage-div">Current Stage: ${a.stage}</div>

            </div>


            `
            
            ).join("");


      };



      function loadRejected(){
        let apps = JSON.parse(localStorage.getItem("applications")) || [];

        let rejected = apps.filter(app => app.stage === "completed" && app.status === "Rejected");
        
        let container = document.getElementById("rejected");
        
        if (rejected.length === 0) {
        container.innerHTML = `<p class="approved-letter-div">No rejected letters .</p>`;
        return;
        }
        
        

        container.innerHTML = rejected.map((a, index) => `
            <div class="approved-letter-div">
            <p class="approved-letter-from"><strong>From:</strong></p><br>
            <p class="approved-letter-from-user">${a.name}</p><br>
            <p class="approved-letter-from-user">${a.department} &nbsp; ${a.year}</p><br>
            <p class="approved-letter-from-user">${a.email}</p><br>
            <p class="approved-letter-from-user">${a.phoneNumber}</p><br>
            <hr>
             <p class="approved-letter-subject"><strong>Subject:</strong> ${a.subject}</p>
            
            
            <p class="approved-letter-body">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;${a.body}</p>
            
            <div class="status-div-rejected"> Rejected by ${a.rejectedAtStage || "Unknown"}</div>
            </div>

            `
            ).join("");
      };


      function downloadPDF(index) {
          let apps = JSON.parse(localStorage.getItem("applications")) || [];

          let approved = apps.filter(
            app => app.stage === "completed" && app.status === "Approved"
          );

          let a = approved[index];
          if (!a) {
            alert("Letter not found");
            return;
          }

          const { jsPDF } = window.jspdf;
          const doc = new jsPDF();

          // ===== HEADER =====
          doc.setFont("times", "bold");
          doc.setFontSize(18);
          doc.text("APPROVAL LETTER", 105, 20, { align: "center" });

          doc.setLineWidth(0.5);
          doc.line(20, 25, 190, 25);

          // ===== DATE =====
          doc.setFont("times", "normal");
          doc.setFontSize(11);
          doc.text(`Date: ${new Date().toLocaleDateString()}`, 150, 35);

          // ===== FROM DETAILS =====
          doc.setFontSize(12);
          doc.setFont("times", "bold");
          doc.text("From:", 20, 50);

          doc.setFont("times", "normal");
          doc.text(a.name, 20, 58);
          doc.text(a.department, 20, 65);
          doc.text(a.year, 20, 72);
          doc.text(a.email, 20, 79);
          doc.text(a.phoneNumber, 20, 86);

          // ===== SUBJECT =====
          doc.setFont("times", "bold");
          doc.text("Subject:", 20, 100);
          doc.setFont("times", "normal");
          doc.text(a.subject, 40, 100);

          // ===== BODY =====
          let bodyText = doc.splitTextToSize(a.body, 170);
          doc.text(bodyText, 20, 115);

          // ===== APPROVAL IMAGE (STAMP / SEAL) =====
          const img = new Image();
          img.src = "approval-image-1.png"; // make sure this path exists

          img.onload = function () {
            // fixed position near bottom-right
            const pageHeight = doc.internal.pageSize.getHeight();
            doc.addImage(img, "PNG", 130, pageHeight - 100, 50, 50);
            doc.save(`Approved_Letter_${a.name}.pdf`);
          };

          img.onerror = function () {
            // fallback if image not found
            doc.setFontSize(10);
            doc.text("APPROVED", 150, finalY + 20);
            doc.save(`Approved_Letter_${a.name}.pdf`);
          };
        }
     
      

      function showTab(tabId) {
      const contents = document.querySelectorAll('.messages');
      contents.forEach(item => item.style.display = 'none');

      document.getElementById(tabId).style.display = 'block';
      
      }
      function showSidebar() {
            const sideBar = document.querySelector('.side-bar');
            sideBar.style.display = 'flex';
        }
        function hideSidebar() {
            const sideBar = document.querySelector('.side-bar');
            sideBar.style.display = 'none';
        }
      
    </script>
  </body>
</html>
