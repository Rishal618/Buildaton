<!DOCTYPE html>
<html>
  <head>
    <title>
      Submitted Letters
    </title>
    <link rel="stylesheet" type="text/css" href="styles/submitted-letters.css">
   
  </head>
  <body>

    <div class="header">
      <div class="home-text">
        <a href="create-application.html">
          <div>
            Home
          </div>
        </a>
      </div>
      <div class="Dashboard-text">
         <a href="create-application.html">
          <p>
            Dashboard
          </p>
          
        </a>
          
      </div>
    </div>


    <div class="status-tabs">
      <div class="tab" onclick="showTab('pending')">
        <p>Pending</p>
      </div>
      <div class="tab" onclick="showTab('approved')">
        <p>Approved</p>
      </div>
      <div class="tab" onclick="showTab('rejected')">
        <p>Rejected</p>
      </div>
    </div>

    <div class="messages-area">
      <div id="pending" class="messages">
        
      </div>
      <div id="approved" class="messages">
        
      </div>
      <div id="rejected" class="messages">
        
      </div>
    </div>



    <div id="pdfContent" style="display:none"></div>
    
    
    <script src="/js/work-flow.js"></script>
     <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js">   
     </script>



    <script>
      function loadApproved(){
        let apps = JSON.parse(localStorage.getItem("applications")) || [];

        let approved = apps.filter(app => app.stage === "completed" && app.status === "Approved");
        
        let container = document.getElementById("approved");

        if (approved.length === 0) {
        container.innerHTML = `<p class="approved-letter-div">No approved letters .</p>`;
        return;
        }
        
        

        container.innerHTML = approved.map((a, index) => `
            <div class="approved-letter-div">
            <p class="approved-letter-from"><strong>From:</strong></p>
            <p class="approved-letter-from-user">${a.name}</p>
            <p class="approved-letter-from-user">${a.department}</p>
            <p class="approved-letter-from-user">${a.year}</p>
            <p class="approved-letter-from-user">${a.email}</p>
            <p class="approved-letter-from-user">${a.phoneNumber}</p>
            <hr>
                        
            
            <p class="approved-letter-subject"><strong>Subject:</strong> ${a.subject}</p>
            
            
            <p class="approved-letter-body">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;${a.body}</p>
            <div class="status-div-approved">Approved</div>
            <div class="download-button-div">
            <button onclick="downloadPDF(${index})" class="approved-download-button">Download Approved Letter</button>
            </div>
          </div>
         
        `
         ).join("");
      };
      loadApproved();
      loadRejected();
      loadPending();
      
      showTab('approved');
      
      function loadPending(){
        let apps = JSON.parse(localStorage.getItem("applications")) || [];

        let pending = apps.filter(app => app.stage === "Advisor" || app.stage === "HOD" || app.stage === "Principal" );
        
        let container = document.getElementById("pending");

        if (pending.length === 0) {
        container.innerHTML = `<p class="approved-letter-div">No pending letters .</p>`;
        return;
        }

         
        
        

        container.innerHTML = pending.map((a, index) => `
            <div class="approved-letter-div">
            <p class="approved-letter-from"><strong>From:</strong></p>
            <p class="approved-letter-from-user">${a.name}</p>
            <p class="approved-letter-from-user">${a.department}</p>
            <p class="approved-letter-from-user">${a.year}</p>
            <p class="approved-letter-from-user">${a.email}</p>
            <p class="approved-letter-from-user">${a.phoneNumber}</p>
            <hr>
             <p class="approved-letter-subject"><strong>Subject:</strong> ${a.subject}</p>
            
            
            <p class="approved-letter-body">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;${a.body}</p>
            <div class="status-div-pending">Pending</div>
            <div class="stage-div">Current Stage: ${a.stage}</div>

            </div>


            `
            
            ).join("");


      };



      function loadRejected(){
        let apps = JSON.parse(localStorage.getItem("applications")) || [];

        let rejected = apps.filter(app => app.stage === "completed" && app.status === "Rejected");
        
        let container = document.getElementById("rejected");
        
        if (rejected.length === 0) {
        container.innerHTML = `<p class="approved-letter-div">No rejected letters .</p>`;
        return;
        }
        
        

        container.innerHTML = rejected.map((a, index) => `
            <div class="approved-letter-div">
            <p class="approved-letter-from"><strong>From:</strong></p>
            <p class="approved-letter-from-user">${a.name}</p>
            <p class="approved-letter-from-user">${a.department}</p>
            <p class="approved-letter-from-user">${a.year}</p>
            <p class="approved-letter-from-user">${a.email}</p>
            <p class="approved-letter-from-user">${a.phoneNumber}</p>
            <hr>
             <p class="approved-letter-subject"><strong>Subject:</strong> ${a.subject}</p>
            
            
            <p class="approved-letter-body">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;${a.body}</p>
            
            <div class="status-div-rejected"> Rejected by ${a.rejectedAtStage || "Unknown"}</div>
            </div>

            `
            ).join("");
      };


      
     
      function downloadPDF(index) {
          
        let apps = JSON.parse(localStorage.getItem("applications")) || [];
        let approved = apps.filter(app => app.status === "Approved");
        let a = approved[index]; 

        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();


        let content = `
From:
${a.name}
${a.department}
${a.year}
${a.email}
${a.phoneNumber}

Subject:${a.subject}

${a.body}
     
        `
              let lines = doc.splitTextToSize(content, 180);
              doc.text(lines, 10, 10);

              let finalY = 10 + lines.length * 7;
              let img = new Image();
              img.src = "approval-image-1.png";
              img.onload = function () {
                const pageWidth = doc.internal.pageSize.getWidth();
                const imgWidth = 50;
                const imgHeight = 50;
                const xPos = (pageWidth - imgWidth) / 2;
                doc.addImage(img, "PNG", xPos,finalY + 10,imgWidth, imgHeight);

                doc.save(`Approved_Letter_${a.name}.pdf`);
              }
      }

      function showTab(tabId) {
      const contents = document.querySelectorAll('.messages');
      contents.forEach(item => item.style.display = 'none');

      document.getElementById(tabId).style.display = 'block';
      
      }
      
    </script>
  </body>
</html>
